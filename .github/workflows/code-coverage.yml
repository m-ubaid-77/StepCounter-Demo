name: Code Coverage

on:
  pull_request:
    branches:
      - '**'

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  code-coverage:
    name: Generate Code Coverage Report
    runs-on: macos-15

    permissions:
      pull-requests: write
      contents: read

    steps:
      # -----------------------------
      # Checkout
      # -----------------------------
      - name: Checkout Repository
        uses: actions/checkout@v4

      # -----------------------------
      # Setup Xcode
      # -----------------------------
      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '26.1.1'

      # -----------------------------
      # Install SwiftLint (optional)
      # -----------------------------
      - name: Install SwiftLint
        run: |
          if ! command -v swiftlint &> /dev/null; then
            echo "SwiftLint not found, installing..."
            brew install swiftlint
          else
            echo "SwiftLint already installed"
          fi

      # -----------------------------
      # Run Code Coverage Script
      # -----------------------------
      - name: Run Coverage Script
        id: coverage
        run: |
          chmod +x ./CodeCov.sh

          if ./CodeCov.sh > coverage_output.txt 2>&1; then
            echo "status=success" >> $GITHUB_OUTPUT

            COVERAGE=$(grep "ğŸ“ˆ App Test Coverage:" coverage_output.txt | awk '{print $5}')
            echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
          fi

          echo "------ Coverage Script Output ------"
          cat coverage_output.txt
          echo "-----------------------------------"

      # -----------------------------
      # Comment Result on PR
      # -----------------------------
      - name: Comment Coverage on PR
        uses: actions/github-script@v6
        with:
          script: |
            const status = '${{ steps.coverage.outputs.status }}';
            const coverage = '${{ steps.coverage.outputs.coverage }}';

            let body;

            if (status === 'success') {
              body = `## ğŸ“Š Code Coverage Report

              âœ… **Build Status**: Passed  
              ğŸ“ˆ **Coverage**: **${coverage}**  

              ğŸŒ¿ **Branch**: \`${{ github.head_ref }}\`  
              ğŸ” **Commit**: \`${{ github.sha }}\``;
            } else {
              body = `## âŒ Build Failed

              The build or test execution failed.  
              Please check **GitHub Actions logs** for details.

              ğŸŒ¿ **Branch**: \`${{ github.head_ref }}\`  
              ğŸ” **Commit**: \`${{ github.sha }}\``;
            }

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

      # -------------------------------------------------
      # Fail workflow if build/test failed
      # -------------------------------------------------
      - name: Fail workflow if build failed
        if: steps.coverage.outputs.status == 'failure'
        run: |
          echo "âŒ Marking GitHub Action as failed"
          exit 1
